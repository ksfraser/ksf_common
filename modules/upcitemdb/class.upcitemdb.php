<?php

/*
*
*	This class is designed to work with Quickform2 as a datasource
*
*/

//https://api.upcitemdb.com/prod/trial/lookup?upc=012569594418                                                     

/*
{
  "code": "OK",
  "total": 1,
  "offset": 0,
  "items": [
    {
      "ean": "0012569594418",
      "title": "Two and a Half Men: Season 1",
      "description": "The life of affluent, carefree jingle writer Charlie Harper (Charlie Sheen) is thrown off-kilter when his tightly wound chiropractor brother, Alan (Jon Cryer), and Alan's 10-year-old son, Jake (Angus T. Jones), come to live with him at his beach house indefinitely in the aftermath of Alan's failed marriage to Judith (Marin Hinkle). Charlie is an unabashed womanizer and Alan is insecure and unlucky in love. While as opposite as brothers can be, they're united in the fact that they each deal with dysfunction...",
      "upc": "012569594418",
      "brand": "Warner Manufacturing",
      "model": "12337576",
      "color": "Black",
      "size": "",
      "dimension": "7.8 X 5.8 X 1 inches",
      "weight": "0.3 Pounds",
      "lowest_recorded_price": 0.97,
      "highest_recorded_price": 61.17,
      "images": [
        "http://img.bbystatic.com/BestBuy_US/images/products/8397/8397914_sc.jpg",
        "http://img1.r10.io/PIC/32103584/0/1/250/32103584.jpg",
        "http://www.shoptv.com/imgcache/product/resized/000/043/913/catl/two-and-a-half-men-season-1-dvd-499_500.jpg?k=0d162b38&pid=43913&s=catl&sn=",
        "http://site.unbeatablesale.com/EB260/igme77459.gif",
        "http://www.cbsstore.com/img/product/catl/000/043/913/two-and-a-half-men-season-1-dvd-499.jpg",
        "http://images10.newegg.com/ProductImageCompressAll200/012569594418-03.jpg",
        "http://dynamic.indigoimages.ca/dvd/012569594418.jpg?width=200&maxheight=200",
        "http://ii.wbshop.com/fcgi-bin/iipsrv.fcgi?FIF=/images/warnerbros/source/warnerbros/508k1yzzcc1snjsrutw3xdz4odqg937dx0xsdxaqx83ikgsgijqfbmi3a4g0td2vdlnq50xscu01m1ru.tif&wid=8000&cvt=jpeg&wbimage=image.jpg",
        "http://images.prosperentcdn.com/images/250x250/ii.wbshop.com/fcgi-bin/iipsrv.fcgi%3FFIF%3D%2Fimages%2Fwarnerbros%2Fsource%2Fwarnerbros%2F508k1yzzcc1snjsrutw3xdz4odqg937dx0xsdxaqx83ikgsgijqfbmi3a4g0td2vdlnq50xscu01m1ru.tif%26wid%3D8000%26cvt%3Djpeg%26wbimage%3Dimage.jpg",
        "http://images.prosperentcdn.com/images/250x250/ii.wbshop.com/fcgi-bin/iipsrv.fcgi%3FFIF%3D%2Fimages%2Fwarnerbros%2Fsource%2Fwarnerbros%2F508k1yzzcc1snjsrutw3xdz4odqg937dx0xsdxaqx83ikgsgijqfbmi3a4g0td2vdlnq50xscu01m1ru.tif%26wid%3D8000%26cvt%3Djpeg%26wbimage%3Dimage.jpg"
      ],
      "offers": [
        {
          "merchant": "Bellacor",
          "domain": "bellacor.com",
          "title": "Two And A Half Men: The Complete First Season Dvd from Warner Bros.",
          "currency": "",
          "list_price": "",
          "price": 22.49,
          "shipping": "",
          "condition": "New",
          "availability": "",
          "link": "http://www.upcitemdb.com/norob/alink/?id=v2p20303w2x2f484y2&tid=1&seq=1512345060&plt=2d05b27c6020f998781eaae39e79d8b2",
          "updated_t": 1478499458
        },
        {
		...
        }
      ],
      "asin": "B00005JOHC",
      "elid": "202080577176"
    }
  ]
}



//////20200812
(
    [code] => OK
    [total] => 1
    [offset] => 0
    [items] => Array
        (
            [0] => Array
                (
                    [ean] => 9780441018697
                    [title] => The Lost Fleet: Victorious - by Jack Campbell (Paperback)
                    [description] =>
                    [isbn] => 9780441018697
                    [publisher] => Ace
                    [category] => Media > Books
                    [images] => Array
                        (
                            [0] => https://covers2.booksamillion.com/covers/bam/0/44/101/869/0441018696.jpg
                            [1] => https://images.BetterWorldBooks.com/044/Victorious-Campbell-Jack-9780441018697.jpg
                            [2] => https://i5.walmartimages.com/asr/510e2fe4-cf96-46d9-9dea-af8b22afde46_1.cfb6ef467acdc18bf5ea1e4dca6ea35e.jpeg?odnHeight=450&odnWidth=450&odnBg=ffffff
                            [3] => https://target.scene7.com/is/image/Target/GUEST_f3f11dcd-2539-4719-a147-7196675ff18f?wid=1000&hei=1000
                            [4] => https://dynamic.indigoimages.ca//books/9780441018697.jpg?width=200&maxheight=200
                            [5] => http://www.printsasiaimages.com/137818267/130405070215ksMo0U7Q.jpg
                            [6] => https://images10.newegg.com/ProductImageCompressAll200/9780441018697-01.jpg
                            [7] => http://i.ebkimg.com/previews/000/000516/000516352/000516352-sml-1.jpg
                            [8] => http://site.unbeatablesale.com/EB233/bkzn22330.gif
                            [9] => https://tshop.r10s.com/494/a91/94de/b272/a09f/03cb/8adc/11a9e98c79c45444891461.jpg?_ex=512x512
                        )

                    [offers] => Array
                        (
                            [0] => Array
                                (
                                    [merchant] => Printsasia.com
                                    [domain] => printsasia.com
                                    [title] => Victorious
                                    [currency] =>
                                    [list_price] =>
                                    [price] => 9.26
                                    [shipping] =>
                                    [condition] => New
                                    [availability] =>
                                    [link] => https://www.upcitemdb.com/norob/alink/?id=u2o253y2w2z26484&tid=3&seq=1597278862&plt=2ce9a78912362cc28d005e8d26f18574
                                    [updated_t] => 1432191974
                                )
			...

                            [15] => Array
                                (
                                    [merchant] => OnBuy.com
                                    [domain] => onbuy.com
                                    [title] => Victorious (Lost Fleet)
                                    [currency] => GBP
                                    [list_price] =>
                                    [price] => 4.5
                                    [shipping] =>
                                    [condition] => New
                                    [availability] =>
                                    [link] => https://www.upcitemdb.com/norob/alink/?id=u2x23323w263b494u2&tid=3&seq=1597278862&plt=0c26c1e2f6772e34bd524db2642a63c4
                                    [updated_t] => 1570020122
                                )

                        )

                    [asin] => 0441018696
                )

        )

)

*/

require_once( '../class.image_url.php' );

class upcitemdb_offer extends origin
{
	protected $merchant;
	protected $domain;
	protected $title;
	protected $currency;
	protected $list_price;
	protected $price;
	protected $shipping;
	protected $condition;
	protected $availability;
	protected $link;
	protected $updated;
	function __construct( $offer_array )
	{
		parent::__construct();
   		$this->tell_eventloop( $this, 'NOTIFY_LOG_DEBUG', get_class( $this ) . "::" . __FUNCTION__ . "::" . __LINE__ );
		foreach( $offer_array as $key=>$val )
		{
			$this->set( $key, $val, false );
		}
	}
}

class upcitemdb extends rest_interface
{
	protected $upcitemdb_baseurl;
	protected $upcitemdb_endpoint;
	protected $download_images;	//!<bool should we download images
	protected $tmpdir;
	protected $code;	//!< string response
	protected $total;
	protected $offset;
	protected $category;
      	protected $ean;
      	protected $upc;
      	protected $brand;
      	protected $model;
      	protected $color;
      	protected $size;
      	protected $dimension;
      	protected $weight;
      	protected $lowest_recorded_price;
      	protected $highest_recorded_price;
	protected $currency;
      var $images = array();
	var $offers = array();
	var $asin;
	var $elid;
		//GOOGLE fields
   	protected $description;       //!< string
        protected $title;             //!< string
        var $title_long;        //!< string
        var $isbn;              //!< string
        var $isbn13;            //!< string
        var $dewey_decimal;     //!< string
        var $binding;           //!< string
        var $publisher;         //!< string
        var $language;          //!< string
        var $date_published;    //!< date-time
        var $edition;           //!< string
        var $pages;             //!< integer
        var $dimensions;        //!< string
        var $overview;          //!< string
        var $image;             //!< image link
        var $msrp;              //!< number
        var $excerpt;           //!< string
        var $synopsys;          //!< string
        var $authors;           //!< structure
        var $subjects;          //!< structure
        var $reviews;           //!< structure
        var $prices;            //!< structure
		//!GOOGLE fields
	public $conversion_array;
	function __construct( $upc = "" ) 
	{ //parent::__construct( $baseurl, $endpoint, $queryval, $key ); 
	 	$this->upcitemdb_baseurl = 'https://api.upcitemdb.com/';   
                $this->upcitemdb_endpoint = '/prod/trial/lookup';
                $this->key = "";
		$tihs->download_images = false;

                $this->tell_eventloop( $this, "READ_INI", dirname( __FILE__ ) . "/../../upcitemdb.ini" );  //UPCItemDB vice isbn
                $this->tell_eventloop( $this, "SETTINGS_QUERY", 'upcitemdb_api_key' );
                $this->tell_eventloop( $this, "SETTINGS_QUERY", 'upcitemdb_baseurl' );
                $this->tell_eventloop( $this, "SETTINGS_QUERY", 'upcitemdb_endpoint' );
                $this->tell_eventloop( $this, "SETTINGS_QUERY", 'download_images' );
                $this->tell_eventloop( $this, "SETTINGS_QUERY", 'download_tmpdir' );
                parent::__construct( $this->upcitemdb_baseurl, $this->upcitemdb_endpoint, $upc, $this->key );

	}

	/*********************************************//**
	 * Build the array used by kalli_data copy_from_source
	 *
	 * kalli_data will copy each of it's fields from ours
	 * using ->get but we have to tell it our field names
	 * The generic way to do that is to pass in an array 
	 * with the equivalencies.
	 *
	 * @param none
	 * @return null
	 * ***********************************************/
	function build_conversion_array()
	{
		$this->conversion_array = array();
		$this->conversion_array['etag'] = "";
		$this->conversion_array['author'] = "authors";
		$this->conversion_array['id'] = "";
		$this->conversion_array['Title'] = "title";
		$this->conversion_array['publisher'] = "publisher";
		$this->conversion_array['year'] = "";
		$this->conversion_array['releasedate'] = "date_published";
		$this->conversion_array['keywords'] = "category";
		$this->conversion_array['comments'] = "excerpt";
		$this->conversion_array['Summary'] = "description";
		$this->conversion_array['Summary'] = "synopsys";
		$this->conversion_array['chaptersURL'] = "";
		$this->conversion_array['azDetailPageURL'] = "";
		$this->conversion_array['isbn13'] = "ean";
		$this->conversion_array['isbn'] = "upc";
		$this->conversion_array['upc'] = "";
		$this->conversion_array['pages'] = "pages";
		$this->conversion_array['numberofdisks'] = "";
		$this->conversion_array['Length'] = "";
		$this->conversion_array['Media'] = "";
		$this->conversion_array['format'] = "";
		$this->conversion_array['image'] = "image";
		$this->conversion_array['Image'] = "";
		$this->conversion_array['coverimage'] = "";
		$this->conversion_array['imdbnumber'] = "";
		$this->conversion_array['ASIN'] = "asin";
		$this->conversion_array['GoogleDetailspage'] = "";
		$this->conversion_array['Coverimage'] = "";
		$this->conversion_array['fields_set'] = "";
		$opts = array( 'brand', 'model', 'color', 'size', 'dimension', 'weight' );
		foreach( $opts as $var )
		{
			$this->conversion_array[ $var ] = $var;
		}
		//averagerating, language
		return;
	}
	/*****************************************************//**
        * SETTINGS_QUERY handler checks for fcn to set value based upon query
        *
        * @param val the Returned setting value
        * @return NONE
        ********************************************************/
        function upcitemdb_api_key( $val )
        {
                $this->tell_eventloop( $this, 'NOTIFY_LOG_DEBUG', 'Setting UPCItemDB Api Key to ' . $val );
                $this->set( 'key', $val );
        }
        /*****************************************************//**
        * SETTINGS_QUERY handler checks for fcn to set value based upon query
        *
        * @param val the Returned setting value
        * @return NONE
        ********************************************************/
        function download_tmpdir( $val )
        {
                $this->tell_eventloop( $this, 'NOTIFY_LOG_DEBUG', 'Setting Download tmpdir to ' . $val );
                $this->set( 'download_tmpdir', $val );
        }
        /*****************************************************//**
        * SETTINGS_QUERY handler checks for fcn to set value based upon query
        *
        * @param val the Returned setting value
        * @return NONE
        ********************************************************/
        function download_images( $val )
        {
                $this->tell_eventloop( $this, 'NOTIFY_LOG_DEBUG', 'Setting Download Images to ' . $val );
                $this->set( 'download_images', $val );
        }
        /*****************************************************//**
        * SETTINGS_QUERY handler checks for fcn to set value based upon query
        *
        * @param val the Returned setting value
        * @return NONE
        ********************************************************/
        function upcitemdb_baseurl( $val )
        {
                $this->tell_eventloop( $this, 'NOTIFY_LOG_DEBUG', 'Setting UPCItemDB Base URL to ' . $val );
                $this->set( 'upcitemdb_baseurl', $val );
        }
        /*****************************************************//**
        * SETTINGS_QUERY handler checks for fcn to set value based upon query
        *
        * @param val the Returned setting value
        * @return NONE
        ********************************************************/
        function upcitemdb_endpoint( $val )
        {
                $this->tell_eventloop( $this, 'NOTIFY_LOG_DEBUG', 'Setting UPCItemDB End Point to ' . $val );
                $this->set( 'upcitemdb_endpoint', $val );
        }
        function build_url()
        {
			//?upc=012569594418

                $this->url = $this->upcitemdb_baseurl . '/' . $this->upcitemdb_endpoint . '?' . 'upc=' . $this->queryval;
		if( isset( $this->key ) AND strlen( $this->key > 2 ) )
			$this->url = $this->url . '&key=' .  $this->key;
                $this->tell_eventloop( $this, 'NOTIFY_LOG_DEBUG', 'URL ' . $this->url );
        }
	/***************************************************************//**
         *build_interestedin
         *
         *      This function builds the table of events that we
         *      want to react to and what handlers we are passing the
         *      data to so we can react.
         * ******************************************************************/
        function build_interestedin()
        {
                $this->interestedin["SEEK_ISBN"]['function'] = "seek_UPC";
                $this->interestedin["SEEK_UPC"]['function'] = "seek_UPC";
                $this->interestedin["NOTIFY_SEARCH_UPCITEMDB"]['function'] = "seek_UPC";	//Depreciate!!
                $this->interestedin["NOTIFY_SEARCH_REMOTE_UPC"]['function'] = "seek_UPC";
                $this->interestedin["UPCITEMDB_SEARCH_UPC"]['function'] = "seek_UPC";
		//UPCITEMDB allows searching.  But not coded yet!!
                //$this->interestedin["UPCITEMDB_SEARCH"]['function'] = "seek_UPC";
        }
        /******************************************************//**
	 * Search for a UPC
	 *
	 * Requires the UPC class.
        *
        * @param caller
        * @param $data
        * @returns array
        ********************************************************/
        function seek_UPC( $caller, $data )
        {
   		$this->tell_eventloop( $this, 'NOTIFY_LOG_DEBUG', get_class( $this ) . "::" . __FUNCTION__ . "::" . __LINE__ );
		require_once( '../class.UPC.php' );
		$upc = new UPC();
		$ret = $upc->setUPC( $caller, $data );
		if( $ret )
		{
   			$this->tell_eventloop( $this, 'NOTIFY_LOG_DEBUG', "Set UPC" );
			$this->set( 'queryval', $upc->get( 'UPC' ) );
                	$ret = $this->run();
                	if( count( $ret ) > 1 )
                		$this->tell_eventloop( $this, 'NOTIFY_UPCITEMDB_RETURN', $ret );
                	return $ret;
		}
		else
			return "";
        }
	function run()
        {	
   		$this->tell_eventloop( $this, 'NOTIFY_LOG_DEBUG', get_class( $this ) . "::" . __FUNCTION__ . "::" . __LINE__ );
                $data = parent::run();
   		$this->tell_eventloop( $this, 'NOTIFY_RESULTS', print_r( $data, true ) );
		if( is_array( $data ) )
		{
			if( $data['code'] = "OK" )
			{
				$itemcount = $data['total'];
				if( $itemcount == null )
					$itemcount = count( $data['items'] );
				/*
				if( $itemcount > 1 )
				{
					//What to do...
				}
				*/
				if( $itemcount == 1 )
				{
					$details = $data['items'][0];	//array
					foreach( $details as $key=>$val )
					{
   						$this->tell_eventloop( $this, 'NOTIFY_LOG_DEBUG', "PROCESS $key" );
						if( $key == "offers" )
						{
							$this->decode_offers( $val );
						}
						else
						if( $key == "images" )
						{
							$this->get_images( $val );
						}
						else
						{
							$this->tell_eventloop( $this, "NOTIFY_LOG_DEBUG", "Set " . $key . " to " . $val );
                        				$this->set( $key, $val, true );
						}
					}
				}
				else
				{
   					$this->tell_eventloop( $this, 'NOTIFY_LOG_ERROR', "Didn't PROCESS due to return count of " . $itemcount );
				}
				$this->build_conversion_array();
				$this->tell_eventloop( $this, 'NOTIFY_DATA_FOR_COPY', $this->conversion_array );
                        	$this->tell_eventloop( $this, 'NOTIFY_FOUND', $data );
   				$this->tell_eventloop( $this, 'NOTIFY_UPCITEMDB_RESULTS', $this );
   				$this->tell_eventloop( $this, 'NOTIFY_RESULTS', print_r( $data, true ) );
			}
		}
   		$this->tell_eventloop( $this, 'NOTIFY_LOG_DEBUG', get_class( $this ) . "::" . __FUNCTION__ . "::" . __LINE__ );
                return $data;
        }
	function get_images( $url )
	{
   		$this->tell_eventloop( $this, 'NOTIFY_LOG_DEBUG', get_class( $this ) . "::" . __FUNCTION__ . "::" . __LINE__ );
		$count = 0;
		if( isset( $this->images_filenames ) )
		{
			if( ! is_array( $this->images_filenames ) )
			{
				unset( $this->images_filenames );
				$this->images_filenames = array();
			}
		}
		foreach( $url as $row )
		{
			$img = new image_url( $row );
			$this->images[] = $img;
			$count++;
			if( $this->download_images == true OR 1 == $this->download_images )
			{
   				$this->tell_eventloop( $this, 'NOTIFY_LOG_DEBUG', "Download Images!" );
				$filename = $this->queryval . "_" . $count . ".jpg";
				$img->download_filename( $this, $filename );
				$img->download_tmpdir( $this, $this->tmpdir );
				if( $img->run() )
				{
					$this->images_filenames[] = $img->get( 'saveto' );
				}
			}
			else
			{
   				$this->tell_eventloop( $this, 'NOTIFY_LOG_DEBUG', "Download Images FALSE!" );
			}
			
		}
	}
	function decode_offers( $offers_arr )
	{
   		$this->tell_eventloop( $this, 'NOTIFY_LOG_DEBUG', get_class( $this ) . "::" . __FUNCTION__ . "::" . __LINE__ );
		foreach( $offers_arr as $offer_arr )
		{
			$offer = new upcitemdb_offer( $offer_arr );
			$this->offers[] = $offer;
		}
	}
/****PARENT**************************
        function run()
        {
                $this->build_url();
                $this->set_header();//UPCItemDB vice isbn
                $this->init_curl();
                $this->curl_query();
                if( $this->decode_json() )
                        return $this->response_decoded;
                else
                        return $this->response_raw;
                        //return NULL;
        }
**********************************/

}


/**
 * Interface for data sources used by HTML_QuickForm2 objects
 */

class search_upcitemdb extends origin
{
	public $details = array();
	/***************************************************************//**
         *build_interestedin
         *
         *      This function builds the table of events that we
         *      want to react to and what handlers we are passing the
         *      data to so we can react.
         * ******************************************************************/
        function build_interestedin()
        {
                $this->interestedin["NOTIFY_UPCITEMDB_RESULTS"]['function'] = "upcitemdb_results";
        }
	function upcitemdb_results( $caller, $msg )
	{
		if( ! is_object( $msg ) )
			throw new Exception( "Expecting a upcitemdb class.", KSF_INVALID_DATA_TYPE );
		//$msg will be type upcitemdb class
		if( "upcitemdb" == get_class( $msg ) )
		{
			try{ 
		        	$this->details['Title'] = $msg->get( 'title' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['author'] = $msg->get( 'author' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['publisher'] = $msg->get( 'publisher' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['year'] = $msg->get( 'releasedate' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['releasedate'] = $msg->get( 'releasedate' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['keywords'] = $msg->get( 'TitleLong' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['comments'] = $msg->get( 'comments' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['Summary'] = $msg->get( 'description' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['comments'] .= $msg->get( 'Notes' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details[''] = $msg->get( 'ASIN' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['ASIN'] = $msg->get( 'asin' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['azDetailPageURL'] = $msg->get( 'azDetailPageURL' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['isbn13'] = $msg->get( 'isbn13' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['isbn'] = $msg->get( 'isbn' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['upc'] = $msg->get( 'upc' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['keywords'] .= "::" . $msg->get( 'keywords' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['pages'] = $msg->get( 'pages' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['numberofdisks'] = $msg->get( 'numberofdisks' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['Length'] = $msg->get( 'Length' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['Media'] = $msg->get( 'Media' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['format'] = $msg->get( 'Media' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['Image'] = $msg->get( 'thumbnail' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['image'] = $msg->get( 'thumbnail' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
		        	$this->details['coverimage'] = $msg->get( 'thumbnail' );
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
			try {
	                	$this->details['imdbnumber'] = "";
			} catch( Exception $e )
			{
				if( $e->getCode() == KSF_FIELD_NOT_SET )
				{
				}
				else
				{
					$this->tell_eventloop( $this, "NOTIFY_LOG_ERROR", "Unhandled Exception: " . $e->getMessage() );
					throw $e;
				}
			}
	                //$this->details['ASIN'] = "";
	                //$this->details['upcitemdb Details page'] = "";
	                //$this->details['Cover Image'] = "";
			$this->tell_eventloop( $this, 'NOTIFY_DETAILS_SET', $this );
		}
		return $this->details;
	}

	function setBarcode( $barcode )
	{
		if( strlen( $barcode ) < 8 )
			return FALSE;
			//throw new Exception( "Bad UPC" );
		if( strlen( $barcode ) == 12 )
		{
		        //convert to EAN
        		$barcode = "0" . $barcode;
        		$this->IdType= "EAN";
		}
		else
		if( strlen( $barcode ) == 10 AND strncasecmp( $barcode, "B00", 3  ) == 0 )
		{
		        $this->IdType= "ASIN";
		}
		else 
		{
        		$this->IdType= "EAN";
		}
		$this->barcode = $barcode;
	}
	public function getValue( $name )
    	{
		$val = parent::getValue( $name );
		if( null != $val )
			return $val;
    	    	else if( isset( $this->product->$name ) )
			return $this->product->$name;
		else
    	        	return null;
    	}
	function upcitemdb2details()
	{
		        $this->details['Title'] = $this->getValue('title');
		        $this->details['author'] = $this->getValue('author');
		        $this->details['publisher'] = $this->getValue('publisher');
		        $this->details['year'] = $this->getValue('releasedate');
		        $this->details['releasedate'] = $this->getValue('releasedate');
		        $this->details['keywords'] = $this->getValue('TitleLong');
		        $this->details['comments'] = $this->getValue('comments');
		        $this->details['Summary'] = $this->getValue('description');
		        $this->details['comments'] .= $this->getValue('Notes');
		        $this->details[''] = $this->getValue('ASIN');
		        $this->details['ASIN'] = $this->getValue('asin');
		        $this->details['azDetailPageURL'] = $this->getValue('azDetailPageURL');
		        $this->details['isbn13'] = $this->getValue('isbn13');
		        $this->details['isbn'] = $this->getValue('isbn');
		        $this->details['upc'] = $this->getValue('upc');
		        $this->details['keywords'] .= "::" . $this->getValue('keywords');
		        $this->details['pages'] = $this->getValue('pages');
		        $this->details['numberofdisks'] = $this->getValue('numberofdisks');
		        $this->details['Length'] = $this->getValue('Length');
		        $this->details['Media'] = $this->getValue('Media');
		        $this->details['format'] = $this->getValue('Media');
		        $this->details['Image'] = $this->getValue('thumbnail');
		        $this->details['image'] = $this->getValue('thumbnail');
		        $this->details['coverimage'] = $this->getValue('thumbnail');
	                $this->details['imdbnumber'] = "";
	                //$this->details['ASIN'] = "";
	                //$this->details['upcitemdb Details page'] = "";
	                //$this->details['Cover Image'] = "";
		$this->ObserverNotify( 'NOTIFY_DETAILS_SET', $this, $this );
		return $this->details;
	}
}

